'use strict';

const { requireAdmin } = require('../_lib/auth');

const HTML = "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n  <meta name=\"robots\" content=\"noindex,nofollow\" />\n  <title>Admin Dashboard</title>\n  <style>\n    :root{--bg:#0a1628;--bg2:#1a0a2e;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--txt:#fff;--muted:rgba(255,255,255,.65);--p:#8b5cf6;--ok:#10b981;--bad:#ef4444;}\n    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;color:var(--txt)}\n    header{position:sticky;top:0;z-index:5;padding:14px 18px;background:var(--card);backdrop-filter:blur(18px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}\n    .brand{font-weight:800;display:flex;align-items:center;gap:10px}\n    .pill{padding:8px 12px;border:1px solid var(--border);background:rgba(255,255,255,.05);border-radius:999px;color:var(--muted);font-size:.9rem}\n    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--txt);cursor:pointer}\n    .btn-primary{border-color:rgba(139,92,246,.5);background:rgba(139,92,246,.18)}\n    .btn-danger{border-color:rgba(239,68,68,.5);background:rgba(239,68,68,.14)}\n    main{max-width:1100px;margin:0 auto;padding:18px}\n    .tabs{display:flex;gap:10px;margin:10px 0 18px}\n    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.05);cursor:pointer}\n    .tab.active{border-color:rgba(139,92,246,.7);background:rgba(139,92,246,.15)}\n    .grid{display:grid;grid-template-columns:1fr;gap:14px}\n    @media(min-width:950px){.grid{grid-template-columns:1.2fr .8fr}}\n    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}\n    h2{margin:0 0 10px;font-size:1.1rem}\n    .muted{color:var(--muted);font-size:.92rem}\n    table{width:100%;border-collapse:collapse;font-size:.92rem}\n    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}\n    th{color:rgba(255,255,255,.8);text-align:left;font-weight:700}\n    input,textarea{width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.07);color:var(--txt);outline:none}\n    textarea{min-height:90px;resize:vertical}\n    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}\n    .actions{display:flex;gap:8px;flex-wrap:wrap}\n    .msg{display:none;margin:10px 0;padding:10px 12px;border-radius:12px;border:1px solid var(--border)}\n    .msg.ok{display:block;border-color:rgba(16,185,129,.45);background:rgba(16,185,129,.12)}\n    .msg.bad{display:block;border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12)}\n    .small{font-size:.85rem;color:var(--muted)}\n    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:6px}\n  </style>\n</head>\n<body>\n<header>\n  <div class=\"brand\">\ud83d\udee1\ufe0f Admin <span class=\"pill\" id=\"status\">checking\u2026</span></div>\n  <div class=\"actions\">\n    <button class=\"btn btn-danger\" id=\"logout\">Logout</button>\n  </div>\n</header>\n\n<main>\n  <div class=\"tabs\">\n    <div class=\"tab active\" data-tab=\"pricing\">Pricing</div>\n    <div class=\"tab\" data-tab=\"reviews\">Reviews</div>\n  </div>\n\n  <div id=\"msg\" class=\"msg\"></div>\n\n  <section id=\"pricing\" class=\"grid\">\n    <div class=\"card\">\n      <h2>Pricing items</h2>\n      <p class=\"muted\">Read/Write via <code>/api/admin/pricing</code></p>\n      <div style=\"overflow:auto\">\n        <table id=\"pricingTable\">\n          <thead><tr>\n            <th>ID</th><th>Title</th><th>Price</th><th>Active</th><th>Popular</th><th>Actions</th>\n          </tr></thead>\n          <tbody></tbody>\n        </table>\n      </div>\n    </div>\n\n    <div class=\"card\">\n      <h2>Create / Update</h2>\n      <p class=\"muted\">Fill fields then <b>Save</b>. If ID is set \u2192 update, otherwise create.</p>\n      <div class=\"row\">\n        <div>\n          <label class=\"small\">ID (leave empty to create)</label>\n          <input id=\"p_id\" placeholder=\"e.g. 3\" />\n        </div>\n        <div>\n          <label class=\"small\">Sort order</label>\n          <input id=\"p_sort\" placeholder=\"0\" />\n        </div>\n      </div>\n      <label class=\"small\">Title</label>\n      <input id=\"p_title\" placeholder=\"Plan title\" />\n      <label class=\"small\">Description</label>\n      <textarea id=\"p_desc\" placeholder=\"Short description\"></textarea>\n      <div class=\"row\">\n        <div>\n          <label class=\"small\">Price (text)</label>\n          <input id=\"p_price\" placeholder=\"e.g. 15\" />\n        </div>\n        <div>\n          <label class=\"small\">Price Robux (optional)</label>\n          <input id=\"p_robux\" placeholder=\"e.g. 1000\" />\n        </div>\n      </div>\n      <label class=\"small\">Features (JSON array)</label>\n      <textarea id=\"p_features\" placeholder='[\"Feature 1\",\"Feature 2\"]'></textarea>\n      <div class=\"row\">\n        <div>\n          <label class=\"small\"><input type=\"checkbox\" id=\"p_active\" checked /> Active</label>\n        </div>\n        <div>\n          <label class=\"small\"><input type=\"checkbox\" id=\"p_popular\" /> Popular</label>\n        </div>\n      </div>\n      <div class=\"actions\">\n        <button class=\"btn btn-primary\" id=\"p_save\">Save</button>\n        <button class=\"btn\" id=\"p_clear\">Clear</button>\n      </div>\n    </div>\n  </section>\n\n  <section id=\"reviews\" class=\"grid\" style=\"display:none\">\n    <div class=\"card\">\n      <h2>Reviews</h2>\n      <p class=\"muted\">Read/Write via <code>/api/admin/reviews</code></p>\n      <div style=\"overflow:auto\">\n        <table id=\"reviewsTable\">\n          <thead><tr>\n            <th>ID</th><th>Author</th><th>Rating</th><th>Active</th><th>Actions</th>\n          </tr></thead>\n          <tbody></tbody>\n        </table>\n      </div>\n    </div>\n\n    <div class=\"card\">\n      <h2>Create / Update</h2>\n      <p class=\"muted\">If ID is set \u2192 update, otherwise create.</p>\n      <div class=\"row\">\n        <div>\n          <label class=\"small\">ID</label>\n          <input id=\"r_id\" placeholder=\"e.g. 12\" />\n        </div>\n        <div>\n          <label class=\"small\">Sort order</label>\n          <input id=\"r_sort\" placeholder=\"0\" />\n        </div>\n      </div>\n      <label class=\"small\">Author</label>\n      <input id=\"r_author\" placeholder=\"Client name\" />\n      <div class=\"row\">\n        <div>\n          <label class=\"small\">Rating (1-5)</label>\n          <input id=\"r_rating\" placeholder=\"5\" />\n        </div>\n        <div>\n          <label class=\"small\">Image URL (optional)</label>\n          <input id=\"r_img\" placeholder=\"https://...\" />\n        </div>\n      </div>\n      <label class=\"small\">Text</label>\n      <textarea id=\"r_text\" placeholder=\"Review text\"></textarea>\n      <label class=\"small\"><input type=\"checkbox\" id=\"r_active\" checked /> Active</label>\n      <div class=\"actions\">\n        <button class=\"btn btn-primary\" id=\"r_save\">Save</button>\n        <button class=\"btn\" id=\"r_clear\">Clear</button>\n      </div>\n    </div>\n  </section>\n</main>\n\n<script>\nconst statusEl = document.getElementById('status');\nconst msgEl = document.getElementById('msg');\n\nfunction getCookie(name){\n  const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\\[\\]\\\\\\/\\+^])/g,'\\\\$1') + '=([^;]*)'));\n  return m ? decodeURIComponent(m[1]) : '';\n}\nfunction csrf(){ return getCookie('yd_csrf'); }\n\nfunction showMsg(ok, text){\n  msgEl.className = 'msg ' + (ok ? 'ok' : 'bad');\n  msgEl.textContent = text;\n  msgEl.style.display = 'block';\n  setTimeout(()=>{ msgEl.style.display='none'; }, 4000);\n}\n\nasync function api(path, opts={}){\n  const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});\n  if (opts.method && opts.method !== 'GET') headers['X-CSRF-Token'] = csrf();\n  const r = await fetch(path, Object.assign({}, opts, {headers}));\n  // Unauthorized is stealth 404\n  if (r.status === 404) throw new Error('Not authorized (404)');\n  const j = await r.json().catch(()=>null);\n  if (!r.ok) throw new Error((j && j.error) ? j.error : 'Request failed');\n  return j;\n}\n\nasync function checkAuth(){\n  try{\n    await api('/api/admin/pricing', {method:'GET'});\n    statusEl.textContent = 'authorized';\n  }catch(e){\n    statusEl.textContent = 'not authorized';\n    // send to login to avoid leaking details\n    location.href = '/admin';\n  }\n}\n\nasync function loadPricing(){\n  const j = await api('/api/admin/pricing', {method:'GET'});\n  const tbody = document.querySelector('#pricingTable tbody');\n  tbody.innerHTML = '';\n  (j.data||[]).forEach(it=>{\n    const tr = document.createElement('tr');\n    tr.innerHTML = `\n      <td>${it.id}</td>\n      <td>${escapeHtml(it.title||'')}</td>\n      <td>${escapeHtml(it.price||'')}</td>\n      <td>${it.is_active? 'yes':'no'}</td>\n      <td>${it.is_popular? 'yes':'no'}</td>\n      <td class=\"actions\">\n        <button class=\"btn\" data-act=\"edit\" data-id=\"${it.id}\">Edit</button>\n        <button class=\"btn btn-danger\" data-act=\"del\" data-id=\"${it.id}\">Delete</button>\n      </td>`;\n    tbody.appendChild(tr);\n  });\n}\n\nasync function loadReviews(){\n  const j = await api('/api/admin/reviews', {method:'GET'});\n  const tbody = document.querySelector('#reviewsTable tbody');\n  tbody.innerHTML = '';\n  (j.data||[]).forEach(it=>{\n    const tr = document.createElement('tr');\n    tr.innerHTML = `\n      <td>${it.id}</td>\n      <td>${escapeHtml(it.author||'')}</td>\n      <td>${it.rating}</td>\n      <td>${it.is_active? 'yes':'no'}</td>\n      <td class=\"actions\">\n        <button class=\"btn\" data-act=\"edit\" data-id=\"${it.id}\">Edit</button>\n        <button class=\"btn btn-danger\" data-act=\"del\" data-id=\"${it.id}\">Delete</button>\n      </td>`;\n    tbody.appendChild(tr);\n  });\n}\n\nfunction escapeHtml(s){return String(s).replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[m]));}\n\ndocument.getElementById('logout').addEventListener('click', async ()=>{\n  try{ await api('/api/admin/logout', {method:'POST'}); }catch(_){}\n  location.href = '/admin';\n});\n\n// tabs\ndocument.querySelectorAll('.tab').forEach(t=>{\n  t.addEventListener('click', async ()=>{\n    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));\n    t.classList.add('active');\n    const tab = t.dataset.tab;\n    document.getElementById('pricing').style.display = (tab==='pricing') ? '' : 'none';\n    document.getElementById('reviews').style.display = (tab==='reviews') ? '' : 'none';\n  });\n});\n\n// pricing actions\ndocument.querySelector('#pricingTable').addEventListener('click', async (e)=>{\n  const b = e.target.closest('button'); if(!b) return;\n  const id = b.dataset.id;\n  if(b.dataset.act==='edit'){\n    // load by scanning current table row data (simple)\n    const row = b.closest('tr').children;\n    document.getElementById('p_id').value = id;\n    document.getElementById('p_title').value = row[1].textContent;\n    document.getElementById('p_price').value = row[2].textContent;\n  }\n  if(b.dataset.act==='del'){\n    if(!confirm('Delete pricing item #' + id + '?')) return;\n    await api('/api/admin/pricing', {method:'DELETE', body: JSON.stringify({id: Number(id)})});\n    showMsg(true, 'Deleted');\n    await loadPricing();\n  }\n});\n\ndocument.getElementById('p_clear').addEventListener('click', ()=>{\n  ['p_id','p_sort','p_title','p_desc','p_price','p_robux','p_features'].forEach(id=>document.getElementById(id).value='');\n  document.getElementById('p_active').checked = true;\n  document.getElementById('p_popular').checked = false;\n});\n\ndocument.getElementById('p_save').addEventListener('click', async ()=>{\n  let features = [];\n  const f = document.getElementById('p_features').value.trim();\n  if (f) { try { features = JSON.parse(f); } catch(e){ return showMsg(false,'Features must be valid JSON array'); } }\n  const payload = {\n    id: document.getElementById('p_id').value ? Number(document.getElementById('p_id').value) : undefined,\n    sort_order: Number(document.getElementById('p_sort').value || 0),\n    title: document.getElementById('p_title').value,\n    description: document.getElementById('p_desc').value,\n    price: document.getElementById('p_price').value,\n    price_robux: document.getElementById('p_robux').value || null,\n    features,\n    is_active: document.getElementById('p_active').checked,\n    is_popular: document.getElementById('p_popular').checked\n  };\n  const isUpdate = Number.isFinite(payload.id);\n  await api('/api/admin/pricing', {method: isUpdate ? 'PUT' : 'POST', body: JSON.stringify(payload)});\n  showMsg(true, isUpdate ? 'Updated' : 'Created');\n  await loadPricing();\n});\n\n// reviews actions\ndocument.querySelector('#reviewsTable').addEventListener('click', async (e)=>{\n  const b = e.target.closest('button'); if(!b) return;\n  const id = b.dataset.id;\n  if(b.dataset.act==='edit'){\n    const row = b.closest('tr').children;\n    document.getElementById('r_id').value = id;\n    document.getElementById('r_author').value = row[1].textContent;\n    document.getElementById('r_rating').value = row[2].textContent;\n  }\n  if(b.dataset.act==='del'){\n    if(!confirm('Delete review #' + id + '?')) return;\n    await api('/api/admin/reviews', {method:'DELETE', body: JSON.stringify({id: Number(id)})});\n    showMsg(true, 'Deleted');\n    await loadReviews();\n  }\n});\n\ndocument.getElementById('r_clear').addEventListener('click', ()=>{\n  ['r_id','r_sort','r_author','r_rating','r_img','r_text'].forEach(id=>document.getElementById(id).value='');\n  document.getElementById('r_active').checked = true;\n});\n\ndocument.getElementById('r_save').addEventListener('click', async ()=>{\n  const payload = {\n    id: document.getElementById('r_id').value ? Number(document.getElementById('r_id').value) : undefined,\n    sort_order: Number(document.getElementById('r_sort').value || 0),\n    author: document.getElementById('r_author').value,\n    rating: Number(document.getElementById('r_rating').value || 5),\n    image_url: document.getElementById('r_img').value || null,\n    text: document.getElementById('r_text').value,\n    is_active: document.getElementById('r_active').checked\n  };\n  const isUpdate = Number.isFinite(payload.id);\n  await api('/api/admin/reviews', {method: isUpdate ? 'PUT' : 'POST', body: JSON.stringify(payload)});\n  showMsg(true, isUpdate ? 'Updated' : 'Created');\n  await loadReviews();\n});\n\n(async ()=>{\n  await checkAuth();\n  await loadPricing();\n  await loadReviews();\n})();\n</script>\n</body>\n</html>\n";

module.exports = async (req, res) => {
  const auth = await requireAdmin(req);
  if (!auth.ok) {
    res.statusCode = 404;
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.end('<!doctype html><title>404 Not Found</title><h1>Not Found</h1>');
    return;
  }

  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.setHeader('Cache-Control', 'no-store');
  res.end(HTML);
};
